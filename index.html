<!DOCTYPE html>

<html>
<head>
    <title>Game Proto 2</title>
    <style>
        body {
            font-family: sans-serif;
            font-size: 24px;
            height: 100%;
            width: 100%;
            padding:0;
            margin: 0;
        }
        input {
            position: relative;
            border: dotted 3px #0033CC;
            border-radius: 10px;
            font-size: 40px;
            padding: 0.25em;
            left: 50%;
            width: 400px;
            margin-left: -200px;
        }
        #sequence_container {
            position: relative;
            width: 100%;
            height: 500px;
            overflow: hidden;
        }
        #objects, #animations {
            position: absolute;
            height: 100%;
            width: 100%;
        }
        #mask {
            display: none;
            position: absolute;
            height: 100%;
            width: 100%;
            top: 0;
            left: 0;
            background-color: rgba(0,0,0,0.4);
        }
        #popup {
            display: none;
            position: absolute;
            height: auto;
            width: auto;
            border: solid 1px #000;
            border-radius: 10px;
            background-color: #FFF;
        }
        #cut_scene {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            display: none;
            background: rgba(0,0,0,0.8);
        }
        .footer {
            position: fixed;
            width: 100%;
            bottom: 0px;
            height: 100px;
            text-align: center;
            color: #FFF;
            background: black;
        }
    </style>
</head>

<body>

<p id="instructions"></p>
<div id="sequence_container"></div>
<input id="input" />

<div id="mask"></div>
<div id="popup">
    <img class='vocab_image' />
    <h1 class='vocab_word'></h1>
    <h2 class='vocab_english'></h2>
    <p class='vocab_definition'></p>
</div>
<div id='cut_scene'>
    <div id='cut_scene_images'></div>
    <div class='footer'>
        <button style='float:right; padding: 25px; font-weight: bold;' onclick='skip()'>Continue</button>
        <p id='cut_scene_text'></p>
    </div>
</div>

<script type="text/javascript" src="libraries/jquery-2.1.0.min.js"></script>
<script type="text/javascript" src="libraries/createjs-2013.12.12.min.js"></script>
<!--script type="text/javascript" src="http://code.createjs.com/createjs-2013.12.12.min.js"></script-->
<!--script type="text/javascript" src="http://code.jquery.com/jquery-2.1.0.min.js"></script-->
<script type='text/javascript'>
var gameData = {
    scenes: [
	{ 
	    number: 1,
	    opening: {
	    	visuals: 'galaxy and image of coyote',
	    	eng: "A long time ago the rain didn't come so the plants couldn't grow to feed the people. The people were very hungry and they prayed to Tqaltkukwpi7 for help. Tqaltkukwpi7 heard the prayers of the people",
	    	spl: 'spl_o_1'
	    },
	    images: [
	    	{
                    id: 'w000',
                    index: 0,
		    xPos: '50%', 
                    yPos: '50%',
                    img: 'images/drawingOfCoyote.jpg'
		}
	    ],
	    instruction: {
		eng: 'Tqaltkukwpi7 needs a helper, ask for help from...',
		spl: 'spl_i_1'
	    },
	    answer: "Sek'lap",
	    closing: {
		sfx: 'coyoteLaugh'
	    }
	},
	{
	    number: 2,
            opening: {
                visuals: 'coyote appears and grins', 
                eng: 'Coyote laughs! He must have heard his name.',
                spl: 'eng_o_2'
            },
            images: [
		{
		    id: 'w000',
                    index: 0,
                    xPos: '50%',
                    yPos: '50%',
		    img: 'images/coyote2.png'
		},
                {
                    id: 'w001',
                    index: 1,
                    xPos: '25%',
                    yPos: '25%',
                    img: 'images/hello.png'
		}
	    ],
	    instruction: {
		eng: 'Hello!',
		spl: 'Waytk!'
	    },
	    answer: 'Waytk',
	    closing: {
		visuals: 'Coyote Smiles',
		sfx: 'coyoteLaugh'
	    }
	},
	{
            number: 3,
            opening: {
            visuals: 'coyote appears and grins', 
                eng: 'and so he sent his helper coyote to take some salmon from the ocean and feed the people. ',
                spl: 'spl_o_3'
            },
            images: [
		{
                    id: 'w003',
                    index: 2,
                    xPos: '50%',
		    yPos: '50%',
                    img: 'images/river.png'
		}
	    ],
            instruction: {
                eng: 'Help coyote find the ocean. What can you follow to find the ocean?',
                spl: 'spl_i_3'
	    },
            answer: "Ck'mu'7lucw",
	    closing: {
		eng: 'Tqaltkukwpi7 told Coyote, "make sure the salmon will be well cared for in their new home before you leave them."',
		spl: 'spl_c_3',
		visuals: 'vis_c_3',
		sfx: 'sfx_c_3'
	    }
	}
    ],
    dictionary: [
	{
            id: 'w000',
            eng: 'Coyote',
            spl: "Sek'lap",
            img: 'images/dictionary/coyote.png',
	    def: 'def_w001'
	},
	{
            id: 'w001',
            eng: 'Hello',
            spl: 'Waytk',
            img: 'images/dictionary/hello.png',
            def: 'def_w001'
        },
        {
            id: 'w002',
            eng: 'River',
            spl: "Ck'mu'7lucw",
            img: 'images/dictionary/river.png',
            def: 'def_w002'
        }
    ]   
}
</script>
<script type="text/javascript">
    /*var xmlhttp, xmlDoc, xmlParsed;
    // xml parse
  if (window.XMLHttpRequest)
    {// code for IE7+, Firefox, Chrome, Opera, Safari
    xmlhttp=new XMLHttpRequest();
    }
  else
    {// code for IE6, IE5
    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
    }
  xmlhttp.open("GET","localData/scenes.xml",false);
  xmlhttp.send();
  xmlDoc=xmlhttp.responseXML;
  console.log(xmlDoc);
  // end xml parse
  xmlParsed = $.parseXML( xmlDoc );
  $xml = $( xmlParsed );
  $title = $xml.find( "scene" );/
    xmlParsed = $.parseXML( xmlDoc );
    $xml = $( xmlParsed );
    $title = $xml.find( "scene" );
    */
    var $ = jQuery,
        game = {
            level : 0,
            minimumWordLength : 3,
            wordsByIndex : gameData.dictionary,
            wordsCollected : [
                true,
                false,
                false,
                false
            ],
            currentScene: undefined,
            currentSceneIndex: 0
        },
        currentLanguage = 'eng';
    // key strokes -> input
    window.onkeypress = function () {
        $('#input').focus();
        window.onkeypress = null;
    }
    function wordsAreEqual(sWord1, sWord2) {
        var answer = sWord1.length === sWord2.length;
        answer = answer && sWord1.toLowerCase() === sWord2.toLowerCase();
        return answer;
    }
    function setPopupContent(wordIndex, posX, posY) {
        console.log('setPopupContent ' + wordIndex);
        var popup = document.getElementById('popup'),
            wordObject = game.wordsByIndex[wordIndex];
        /*
        
    <img class='vocab_image' />
    <h1 class='vocab_word'></h1>
    <h2 class='vocab_english'></h2>
    <p class='vocab_definition'></p>
        */
        popup.getElementsByTagName('img')[0].src = wordObject.img;
        popup.getElementsByTagName('h1')[0].textContent = wordObject.spl;
        popup.getElementsByTagName('h2')[0].textContent = wordObject.eng;
        popup.getElementsByTagName('p')[0].textContent = wordObject.def;
        popup.style.top = posY + 'px';
        popup.style.left = posX + 'px';
    }
    function setPopupPosition(x, y) {
        console.log('setPopupPosition ' + x + ' ' + y);
        var popup = document.getElementById('popup');
        popup.setAttribute('left', x);
        popup.setAttribute('top', y);
    }
    function loadScene(iSceneNumber) {
        console.log('loadScene ' + iSceneNumber);
        // TODO:
        var scene, i, l, div, img, instructions;
        
        //scene
        scene = gameData.scenes[iSceneNumber];
        if (!scene) {
            alert('Tqaltkukwpi7 told Coyote, "make sure the salmon will be well cared for in their new home before you leave them."');
            return;
        }
        game.domScene.innerHTML = "";
        // bg
        div = document.createElement('div');
        div.setAttribute('id', 'bg');
        game.domScene.appendChild(div);
        // clickable
        div = document.createElement('div');
        div.setAttribute('id', 'clickable_elements');
        game.domScene.appendChild(div);
        //
        //
        l = scene.images.length;
        for (i = 0; i < l; i++) {
            // place images
            img = document.createElement('img');
            img.setAttribute('id', scene.images[i].id);
            img.setAttribute('position', 'absolute');
            img.setAttribute('src', scene.images[i].img);
            img.setAttribute('left', scene.images[i].xPos);
            img.setAttribute('top', scene.images[i].yPos);
            img.setAttribute('data-word-index', scene.images[i].index);
            img.setAttribute('data-clickable', 'true');
            img.onclick = imageClickHandler;
            div.appendChild(img);
        }
        // set words
        // set text
        instructions = document.getElementById('instructions');
        instructions.textContent = scene.instruction[currentLanguage];
        // set answer
        game.answer = scene.answer;
        // play sound
        // play cut scene
        document.getElementById('cut_scene_text').textContent = scene.opening[currentLanguage];
        playScene();
        
    }
    function playScene() {
        game.cutScene.style.display = 'block';
    }
    function skip() {
        game.cutScene.style.display = 'none';
    }
    
    function imageClickHandler(e) {
        var wordIndex;
        console.log('image click');
        // TODO: set pop-up text from e.target.getAttribute('id') or data
        wordIndex = e.currentTarget.getAttribute('data-word-index');
        setPopupContent(wordIndex, e.clientX, e.clientY);
        // show mask
        $('#mask').show();
        // show pop-up
        $('#popup').show();
        e.stopPropagation();
    }
    // functions
    function inputChange (e) {
        var isCorrect = game.check(this.value),
            wordObj,
            i,
            l = game.wordsByIndex.length;
        if (isCorrect) {
            // TODO: run correct animation & move to the next stage
            game.level++;
            game.currentSceneIndex++;
            window.alert('Correct!');
            loadScene(game.currentSceneIndex)
            this.value='';
        } else if (this.value.length > game.minimumWordLength) {
            for (i = 0; i < l; i++) {
                wordObj = game.wordsByIndex[i];
                if (wordsAreEqual(wordObj.spl, this.value)) {
                    game.level--;
                    setPopupContent(i, 500, 100);
                    // show mask
                    $('#mask').show();
                    // show pop-up
                    $('#popup').show();
                    this.value='';
                }
            }
        }
    }
    game.check = function (sWord) {
        if (wordsAreEqual(this.answer, sWord)) {
            return true;
        }
        return false;
    }
    game.hidePopup = function (e) {
        $('#mask').hide();
        $('#popup').hide();
        e.stopPropagation();
    };
    // Init
    function init() {
        var i, l, images;
        $('#mask').hide();
        $('#popup').hide();
        game.domScene = document.getElementById('sequence_container');
        game.cutScene = document.getElementById('cut_scene');
        // popup
        game.popup = document.getElementById('popup');
        game.mask = document.getElementById('mask');
        game.popup.onclick = game.hidePopup;
        game.mask.onclick = game.hidePopup;
        document.getElementById('input').addEventListener('input', inputChange);
        loadScene(game.currentSceneIndex);
    }
    // Start
    $(document).ready(init);
</script>

</body>
</html>
